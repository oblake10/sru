<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa GTA - Carreras</title>

  <!-- Leaflet (CDN) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <link rel="icon" type="image/png" href="./images/logo.png">
  <link rel="stylesheet" href="./style.css" />
</head>

<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <img src="./images/logo.png" alt="Logo" class="logo">
        <div class="title">Mapa de Carreras - San Andreas Highway Patrol</div>
      </div>

      <div class="tools">
        <button id="btnCreateRoute" class="btn secondary" type="button">
          Crear ruta
        </button>
        <button id="btnSaveRace" class="btn primary" type="button" disabled hidden>
          Guardar carrera
        </button>
        <button id="btnUndoPoint" class="btn secondary" type="button">Borrar último punto</button>
        <button id="btnPrintRoute" class="btn secondary" type="button">Imprimir ruta</button>
        <button id="btnCoords" class="btn secondary" type="button" aria-pressed="false">Modo coordenadas: OFF</button>
      </div>
    </header>

    <div class="content">
      <aside class="panel">
        <div class="panel-title">Carreras</div>

        <button id="btnToggleAllRaces" class="btn secondary btn-block" type="button">
          Ver carreras
        </button>

        <div id="raceList" class="race-list"></div>

        <hr class="sep" />

        <div id="coordsBox" class="coords-box hidden">
          <div class="coords-title">Coordenadas (último clic)</div>
          <div id="coordsText" class="coords-text">—</div>
          <div class="coords-hint">Copia esto para crear puntos de ruta en <code>route.js</code></div>
        </div>
      </aside>

      <main class="map-wrap">
        <div id="map"></div>
        <div id="floatingButtons" class="floating-buttons"></div>
      </main>
    </div>
  </div>
  <dialog id="dlgRace">
    <form id="frmRace" method="dialog">
      <h2>Crear carrera</h2>

      <label for="raceName">Nombre</label>
      <input id="raceName" type="text" placeholder="Ej: Carrera Verde — Ruta 01" />

      <label for="raceType">Tipo</label>
      <select id="raceType">
        <option value="laps">laps</option>
        <option value="sprint">sprint</option>
      </select>

      <label for="raceLaps">Número de vueltas</label>
      <input id="raceLaps" type="number" min="0" />

      <div class="dlg-actions">
        <button id="btnCancelRace" type="button">Cancelar</button>
        <button type="submit">Empezar a dibujar</button>
      </div>
    </form>
  </dialog>


  <script src="./mapCore.js"></script>
  <script src="./uiRaces.js"></script>
  <script src="./raceDialog.js"></script>



  <!-- 3) Firebase Modular (MÓDULO) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
 import {
  getFirestore,
  collection,
  addDoc,
  onSnapshot,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";


    const firebaseConfig = {
      apiKey: "AIzaSyDkxJ6z-IgPCzbwtMJlJy5dKGgGsN5rpII",
      authDomain: "proyecto-sru.firebaseapp.com",
      projectId: "proyecto-sru",
      storageBucket: "proyecto-sru.firebasestorage.app",
      messagingSenderId: "168307452493",
      appId: "1:168307452493:web:f036951713ba6fbf1d4a04"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // para tus JS "normales"
    window.db = db;
    window.fs = { collection, addDoc };
    // ✅ Cargar carreras desde Firestore y refrescar la lista
const q = query(collection(db, "races"), orderBy("createdAt", "desc"));

onSnapshot(q, (snap) => {
  const races = snap.docs.map((d) => {
    const data = d.data();

    // Firestore: [{lat,lng}] -> App/Leaflet: [[lat,lng]]
    const path = (data.path || []).map((p) => [p.lat, p.lng]);

    return {
      id: d.id,
      name: data.name || "Sin nombre",
      laps: Number.isFinite(data.laps) ? data.laps : 1,
      color: data.color || "#1e90ff",
      start: data.start ? [data.start.lat, data.start.lng] : (path[0] || null),
      path,
    };
  });

  window.RACES = races;

  // refresca panel izquierdo
  if (window.App && typeof window.App.refreshRaceList === "function") {
    window.App.refreshRaceList();
  }
});

  </script>
</body>


</html>